<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My LIFF App</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding-top: 50px;
        }

        button {
            padding: 10px 20px;
            background: #00b900;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>ยินดีต้อนรับสู่ LIFF App</h1>
    <div id="content">
        <p>กำลังโหลดข้อมูล...</p>
    </div>

    <script>
        async function main() {
            try {
                await liff.init({ liffId: "2008732159-jmjoiZJc" });

                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login(); // ถ้าเปิดผ่าน Browser อื่นจะบังคับ Login
                }
            } catch (err) {
                console.error("LIFF Initialization failed", err);
            }
        }

        async function sendMessages() {
            try {
                await liff.sendMessages([{
                    type: 'text',
                    text: 'Hello, this is a test message from LIFF app.'
                }]);
                alert("Message sent!");
            } catch (err) {
                console.error("LIFF send message failed", err);
                alert("Error sending message: " + err.message + "\n\nPlease ensure 'chat_message.write' scope is enabled in LINE Developers Console.");
            }
        }

        async function getUserProfile() {
            const profile = await liff.getProfile();
            document.getElementById("content").innerHTML = `
                <img src="${profile.pictureUrl}" width="100" style="border-radius:50%">
                <p>สวัสดีคุณ <b>${profile.displayName}</b></p>
                <div style="display:flex; flex-direction:column; gap:10px; align-items:center;">
                    <button onclick="sendMessages()">ส่งข้อความไปยัง LINE</button>
                    <button onclick="logout()" style="background:#cc0000;">Log Out (Refresh Config)</button>
                </div>
            `;
        }

        function logout() {
            liff.logout();
            window.location.reload();
        }

        async function sendMessages() {
            try {
                await liff.sendMessages([{
                    type: 'text',
                    text: 'Hello, this is a test message from LIFF app.'
                }]);
                alert("Message sent!");
            } catch (err) {
                console.error("LIFF send message failed", err);
                const context = liff.getContext();
                const contextType = context ? context.type : "Unknown";
                alert(`Error: ${err.message}\n\nContext: ${contextType}\n\nPotentially stale permissions. Please click 'Log Out' to refresh your token.`);
            }
        }

        main();
    </script>
</body>

</html>